<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= blog.title %></title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="container">
    <header class="blog-header">
      <h1><%= blog.title %></h1>
    </header>

    <section class="blog-content">
      <% if (blog.image) { %>
        <img src="/uploads/<%= blog.image %>" alt="Blog Image" class="blog-image" />
      <% } %>
      <p class="content-text"><%= blog.content %></p>

      <% if (user && blog.author && user.id.toString() === blog.author.toString()) { %>
        <div class="author-actions">
          <a href="/blogs/<%= blog.id %>/edit" class="btn edit-btn">Edit</a>
          <a href="/blogs/<%= blog.id %>/delete" class="btn delete-btn" onclick="return confirm('Are you sure you want to delete this blog?')">Delete</a>
        </div>
      <% } %>
    </section>

    <hr>

    <section class="reactions">
      <p>‚ù§Ô∏è Likes: <span id="likeCount">0</span> | üëé Dislikes: <span id="dislikeCount">0</span></p>

      <% if (user) { %>
        <button class="btn react-btn" onclick="react('<%= blog.id %>', 'like')">Like</button>
        <button class="btn react-btn" onclick="react('<%= blog.id %>', 'dislike')">Dislike</button>
      <% } else { %>
        <p><a href="/auth/login">Login to react</a></p>
      <% } %>
    </section>

    <section class="comments-section">
      <h2>Comments</h2>

      <% if (comments && comments.length > 0) { %>
        <ul class="comment-list">
          <% comments.forEach(comment => { %>
            <li class="comment-item">
              <strong><%= comment.author_name %></strong>: <%= comment.content %>
              <br>
              <small><%= new Date(comment.created_at).toLocaleString() %></small>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p>No comments yet.</p>
      <% } %>

      <% if (user) { %>
        <form action="/comments/<%= blog.id %>" method="POST" class="comment-form">
          <textarea name="content" required placeholder="Write your comment here..." rows="4" cols="50"></textarea><br>
          <button type="submit" class="btn">Post Comment</button>
        </form>
      <% } else { %>
        <p><a href="/auth/login">Login</a> to comment.</p>
      <% } %>
    </section>
  </div>

  <script>
    async function fetchReactions(blogId) {
      const res = await fetch(`/blogs/${blogId}/reactions`);
      const data = await res.json();
      document.getElementById('likeCount').textContent = data.likes;
      document.getElementById('dislikeCount').textContent = data.dislikes;
    }

    async function react(blogId, type) {
      const res = await fetch(`/blogs/${blogId}/react`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ type })
      });

      if (res.ok) {
        fetchReactions(blogId);
      }
    }

    fetchReactions('<%= blog.id %>');
  </script>
</body>
</html>
